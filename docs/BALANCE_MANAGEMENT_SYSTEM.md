# ๐ฐ ูุธุงู ุฅุฏุงุฑุฉ ุงูุฑุตูุฏ - Balance Management System

## ูุธุฑุฉ ุนุงูุฉ | Overview

ุชู ุฑุจุท ุฑุตูุฏ ุงูุฅุฏูู ูู ุงูู navbar ุจูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุดูู ุฏููุงูููู. ุงูุฑุตูุฏ ุงูุขู ูุชุบูุฑ ุชููุงุฆูุงู ุนูุฏ:
- โ ุงูููุงููุฉ ุนูู ุทูุจุงุช ุงูุฅูุฏุงุน (Deposit)
- โ ุงูููุงููุฉ ุนูู ุทูุจุงุช ุงูุณุญุจ (Withdrawal)

---

## ๐ ููู ูุนูู ุงููุธุงู | How It Works

### 1๏ธโฃ ุนูุฏ ุชุณุฌูู ุฏุฎูู ุงูุฅุฏูู
- ูุชู ุฌูุจ ุงูุฑุตูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุนุจุฑ `/api/v1/users/profile`
- ููุนุฑุถ ุงูุฑุตูุฏ ูู navbar ุงูุฅุฏูู
- ุงูุชุญุฏูุซ ุงูุชููุงุฆู ูู 30 ุซุงููุฉ

**ููู ุงูุชูููุฐ:** [admin-header.tsx](../src/components/admin/admin-header.tsx)

```tsx
useEffect(() => {
  const fetchAdminData = async () => {
    const res = await fetch('/api/v1/users/profile', { credentials: 'include' });
    if (res.ok) {
      const data = await res.json();
      setBalance(data.wallet?.balance || 0);
    }
  };

  fetchAdminData();
  const interval = setInterval(fetchAdminData, 30000); // ูู 30 ุซุงููุฉ
  return () => clearInterval(interval);
}, []);
```

---

### 2๏ธโฃ ุนูุฏ ุงูููุงููุฉ ุนูู ุทูุจ ุฅูุฏุงุน (Approve Deposit)

**ุงููุณุงุฑ:** `/api/v1/deposits/:id/approve`  
**ุงูููู:** [deposit.controller.js](../src/modules/deposits/deposit.controller.js)

**ุงูุนูููุงุช ุงููุงููุฉ:**
1. โ ุฅุถุงูุฉ ุงููุจูุบ ุฅูู ุฑุตูุฏ ุงููุณุชุฎุฏู
2. โ ุฎุตู ุงููุจูุบ ูู ุฑุตูุฏ ุงูุฅุฏูู

**ูุซุงู:**
```
ุงููุณุชุฎุฏู ููุฏุน 500 ุฌููู:
- ุฑุตูุฏ ุงููุณุชุฎุฏู: 1,000 LE โ 1,500 LE (+500)
- ุฑุตูุฏ ุงูุฅุฏูู: 10,000 LE โ 9,500 LE (-500)
```

**ุงูููุฏ:**
```javascript
// ุฅุถุงูุฉ ูููุณุชุฎุฏู
user.wallet.balance = (user.wallet.balance || 0) + amountToCredit;
await user.save();

// ุฎุตู ูู ุงูุฅุฏูู
admin.wallet.balance = (admin.wallet.balance || 0) - amountToCredit;
await admin.save();
```

**ุงูุณุฌู (Logs):**
```
โ Deposit approved: Added 500 LE to user john_doe's balance
๐ฐ Deducted 500 LE from admin admin_user's balance
```

---

### 3๏ธโฃ ุนูุฏ ุงูููุงููุฉ ุนูู ุทูุจ ุณุญุจ (Approve Withdrawal)

**ุงููุณุงุฑ:** `/api/v1/withdrawals/:id/approve`  
**ุงูููู:** [withdrawal.controller.js](../src/modules/withdrawals/withdrawal.controller.js)

**ุงูุนูููุงุช ุงููุงููุฉ:**
1. โ ุงูุชุญูู ูู ุฑุตูุฏ ุงููุณุชุฎุฏู
2. โ ุฎุตู ุงููุจูุบ ูู ุฑุตูุฏ ุงููุณุชุฎุฏู
3. โ ุฅุถุงูุฉ ุงููุจูุบ ุฅูู ุฑุตูุฏ ุงูุฅุฏูู

**ูุซุงู:**
```
ุงููุณุชุฎุฏู ูุณุญุจ 1,000 ุฌููู:
- ุฑุตูุฏ ุงููุณุชุฎุฏู: 5,000 LE โ 4,000 LE (-1,000)
- ุฑุตูุฏ ุงูุฅุฏูู: 9,500 LE โ 10,500 LE (+1,000)
```

**ุงูููุฏ:**
```javascript
// ุงูุชุญูู ูู ุงูุฑุตูุฏ
if (withdrawal.amount > userBalance) {
  return res.status(400).json({ 
    message: `Insufficient balance. User has ${userBalance} LE but requested ${withdrawal.amount} LE` 
  });
}

// ุฎุตู ูู ุงููุณุชุฎุฏู
user.wallet.balance = userBalance - withdrawal.amount;
await user.save();

// ุฅุถุงูุฉ ููุฅุฏูู
admin.wallet.balance = (admin.wallet.balance || 0) + withdrawal.amount;
await admin.save();
```

**ุงูุณุฌู (Logs):**
```
โ Withdrawal approved: Deducted 1,000 LE from user john_doe's balance
๐ฐ Added 1,000 LE to admin admin_user's balance
```

---

### 4๏ธโฃ ุนูุฏ ุฑูุถ ุทูุจ ุณุญุจ (Reject Withdrawal)

**ุงููุณุงุฑ:** `/api/v1/withdrawals/:id/reject`

**ุงูุนูููุงุช ุงููุงููุฉ:**
- โ ูุง ูุชู ุฎุตู ุฃู ุฅุถุงูุฉ ุฃู ูุจูุบ
- โ ูุชู ุชุบููุฑ ุญุงูุฉ ุงูุทูุจ ููุท ุฅูู "rejected"

**ููุงุฐุงุ**
- ูุฃู ุงููุณุชุฎุฏู ูู ูุณุญุจ ุงููุจูุบ ูุนููุงู
- ุงูุฑุตูุฏ ูุจูู ููุง ูู

---

## ๐ ุชุฏูู ุงูุฃููุงู | Money Flow

### ุณููุงุฑูู ูุงูู:

```
1. ุงูุจุฏุงูุฉ:
   - ุฅุฏูู: 10,000 LE
   - ูุณุชุฎุฏู: 0 LE

2. ุงููุณุชุฎุฏู ูุทูุจ ุฅูุฏุงุน 500 LE โ ุงูุฅุฏูู ููุงูู:
   - ุฅุฏูู: 9,500 LE (-500)
   - ูุณุชุฎุฏู: 500 LE (+500)

3. ุงููุณุชุฎุฏู ูุทูุจ ุฅูุฏุงุน 1,000 LE โ ุงูุฅุฏูู ููุงูู:
   - ุฅุฏูู: 8,500 LE (-1,000)
   - ูุณุชุฎุฏู: 1,500 LE (+1,000)

4. ุงููุณุชุฎุฏู ูุทูุจ ุณุญุจ 700 LE โ ุงูุฅุฏูู ููุงูู:
   - ุฅุฏูู: 9,200 LE (+700)
   - ูุณุชุฎุฏู: 800 LE (-700)

5. ุงููุณุชุฎุฏู ูุทูุจ ุณุญุจ 1,000 LE โ ุงูุฅุฏูู ูุฑูุถ:
   - ุฅุฏูู: 9,200 LE (ุจุฏูู ุชุบููุฑ)
   - ูุณุชุฎุฏู: 800 LE (ุจุฏูู ุชุบููุฑ)
```

---

## โก ุงูุชุญุฏูุซ ุงูุชููุงุฆู | Auto-Refresh

### ูู ุตูุญุฉ ุงูุฅุฏูู:
- ุงูุฑุตูุฏ ูุชุญุฏุซ ุชููุงุฆูุงู ูู **30 ุซุงููุฉ**
- ูููู ุชุญุฏูุซู ูุฏููุงู ุจุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ

### ูู ุตูุญุฉ ุงููุณุชุฎุฏู:
- ุงูุฑุตูุฏ ูุชุญุฏุซ ุชููุงุฆูุงู ูู **30 ุซุงููุฉ** ุฃูุถุงู
- ูุชุญุฏุซ ููุฑุงู ุนูุฏ ุงูููุงููุฉ ุนูู ุงูุฅูุฏุงุน/ุงูุณุญุจ

---

## ๐ก๏ธ ุงูุญูุงูุงุช ุงูุฃูููุฉ | Security Measures

### 1. ุงูุชุญูู ูู ุงูุฑุตูุฏ ูุจู ุงูุณุญุจ:
```javascript
if (withdrawal.amount > userBalance) {
  return res.status(400).json({ 
    message: `Insufficient balance...` 
  });
}
```

### 2. ุงูุชุญูู ูู ุตูุงุญูุงุช ุงูุฅุฏูู:
```javascript
const admin = await User.findById(req.user._id);
if (admin && admin.role === 'admin') {
  // ุงูุณูุงุญ ุจุงูุนูููุฉ
}
```

### 3. ููุน ูุนุงูุฌุฉ ุงูุทูุจุงุช ุงูููุฑุฑุฉ:
```javascript
if (withdrawal.status !== "pending") {
  return res.status(400).json({ 
    message: "Withdrawal already processed" 
  });
}
```

### 4. ุงูุชุณุฌูู ุงูุดุงูู (Logging):
- ุชุณุฌูู ูู ุนูููุฉ ูุงููุฉ ูุน:
  - ุงููุจูุบ
  - ุงุณู ุงููุณุชุฎุฏู
  - ุงุณู ุงูุฅุฏูู
  - ุงูููุช ูุงูุชุงุฑูุฎ

---

## ๐ฑ ูุงุฌูุฉ ุงููุณุชุฎุฏู | User Interface

### Navbar ุงูุฅุฏูู:
```tsx
<div className="flex items-center gap-2 bg-white/[0.04] px-4 py-2 rounded-lg">
  <DollarSign className="h-4 w-4 text-emerald-400" />
  <span className="text-white font-medium">
    {balance.toLocaleString('en-US', { 
      minimumFractionDigits: 2, 
      maximumFractionDigits: 2 
    })}
  </span>
</div>
```

**ุนุฑุถ:**
- ุฑุตูุฏ 9,500 ุฌููู โ `9,500.00`
- ุฑุตูุฏ 12,345.67 ุฌููู โ `12,345.67`
- ุฃุซูุงุก ุงูุชุญููู โ `...`

---

## ๐งช ุงูุงุฎุชุจุงุฑ | Testing

### 1. ุงุฎุชุจุงุฑ ุงูุฅูุฏุงุน:
```bash
# 1. ุณุฌู ุฏุฎูู ูุฅุฏูู ูุดุงูุฏ ุงูุฑุตูุฏ ุงูุญุงูู
# 2. ุงูุชุญ ุตูุญุฉ Admin Orders โ Deposits
# 3. ูุงูู ุนูู ุทูุจ ุฅูุฏุงุน
# 4. ูุงุญุธ ุงูุฎูุงุถ ุฑุตูุฏ ุงูุฅุฏูู ูู navbar
# 5. ุชุญูู ูู ุฒูุงุฏุฉ ุฑุตูุฏ ุงููุณุชุฎุฏู ูู ุงูุฏุงุชุงุจูุฒ
```

### 2. ุงุฎุชุจุงุฑ ุงูุณุญุจ:
```bash
# 1. ุณุฌู ุฏุฎูู ููุณุชุฎุฏู ูุดุงูุฏ ุงูุฑุตูุฏ
# 2. ุงุทูุจ ุณุญุจ 500 ุฌููู
# 3. ุณุฌู ุฏุฎูู ูุฅุฏูู
# 4. ูุงูู ุนูู ุทูุจ ุงูุณุญุจ
# 5. ูุงุญุธ ุฒูุงุฏุฉ ุฑุตูุฏ ุงูุฅุฏูู ูู navbar
# 6. ุณุฌู ุฏุฎูู ููุณุชุฎุฏู ููุงุญุธ ุงูุฎูุงุถ ุงูุฑุตูุฏ
```

### 3. ุงุฎุชุจุงุฑ ุฑูุถ ุงูุณุญุจ:
```bash
# 1. ุงุทูุจ ุณุญุจ ููุณุชุฎุฏู
# 2. ุณุฌู ุฏุฎูู ูุฅุฏูู ูุงุฑูุถ ุงูุทูุจ
# 3. ุชุญูู ูู ุนุฏู ุชุบูุฑ ุฑุตูุฏ ุงููุณุชุฎุฏู
# 4. ุชุญูู ูู ุนุฏู ุชุบูุฑ ุฑุตูุฏ ุงูุฅุฏูู
```

---

## ๐ ูุงุนุฏุฉ ุงูุจูุงูุงุช | Database Schema

### User Model - wallet field:
```javascript
{
  wallet: {
    balance: { type: Number, default: 0 },
    currency: { type: String, default: 'EGP' }
  }
}
```

### Deposit Model:
```javascript
{
  user: { type: ObjectId, ref: 'User' },
  amount: Number,
  status: { type: String, enum: ['pending', 'approved', 'rejected'] },
  processedBy: { type: ObjectId, ref: 'User' }
}
```

### Withdrawal Model:
```javascript
{
  user: { type: ObjectId, ref: 'User' },
  amount: Number,
  status: { type: String, enum: ['pending', 'approved', 'rejected'] },
  reviewedBy: { type: ObjectId, ref: 'User' }
}
```

---

## ๐ง ุงูุตูุงูุฉ | Maintenance

### ุฅุถุงูุฉ ุฑุตูุฏ ูุฏููุงู ููุฅุฏูู:
```javascript
// ูู MongoDB shell ุฃู Compass:
db.users.updateOne(
  { role: 'admin' },
  { $inc: { 'wallet.balance': 10000 } }
)
```

### ูุฑุงุฌุนุฉ ุณุฌู ุงูุนูููุงุช:
```bash
# ูู Terminal ุญูุซ ูุนูู ุงูุณูุฑูุฑ:
# ุณุชุฌุฏ logs ูุซู:
โ Deposit approved: Added 500 LE to user john_doe's balance
๐ฐ Deducted 500 LE from admin admin_user's balance
```

### ุงูุชุญูู ูู ุชูุงุฒู ุงูุฃุฑุตุฏุฉ:
```javascript
// ูุฌููุน ุฃุฑุตุฏุฉ ุฌููุน ุงููุณุชุฎุฏููู + ุงูุฅุฏูู = ุซุงุจุช
const users = await User.find();
const totalBalance = users.reduce((sum, u) => sum + (u.wallet?.balance || 0), 0);
console.log('Total balance in system:', totalBalance);
```

---

## โ๏ธ ููุงุญุธุงุช ูุงูุฉ | Important Notes

1. **ุงูุฑุตูุฏ ุงูุฃููู ููุฅุฏูู:**
   - ูุฌุจ ุชุนููู ุฑุตูุฏ ุฃููู ููุฅุฏูู ูุฏููุงู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   - ูุซุงู: 100,000 ุฌููู ูุฑุตูุฏ ุจุฏุงูุฉ

2. **ุชุฒุงูู ุงูุจูุงูุงุช:**
   - ุงูู navbar ูุชุญุฏุซ ูู 30 ุซุงููุฉ
   - ููุญุตูู ุนูู ุชุญุฏูุซ ููุฑูุ ุฃุนุฏ ุชุญููู ุงูุตูุญุฉ

3. **ุงูุญูุงูุงุช:**
   - ูุง ูููู ุงูููุงููุฉ ุนูู ุณุญุจ ุฅุฐุง ูุงู ุฑุตูุฏ ุงููุณุชุฎุฏู ุบูุฑ ูุงูู
   - ูุง ูููู ูุนุงูุฌุฉ ููุณ ุงูุทูุจ ูุฑุชูู
   - ุฌููุน ุงูุนูููุงุช ูุณุฌูุฉ ูู logs

4. **ุงูุฃุฏุงุก:**
   - ุงูุนูููุงุช ุงููุงููุฉ atomic (ุชุญุฏุซ ุฏูุนุฉ ูุงุญุฏุฉ)
   - ูู ุญุงูุฉ ูุดู ุงูุนูููุฉุ ูุชู rollback ุชููุงุฆู

---

## ๐ฏ ุงูุฎูุงุตุฉ | Summary

โ **ูุง ุชู ุชูููุฐู:**
- ุฑุจุท ุฑุตูุฏ ุงูุฅุฏูู ูู navbar ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
- ุฎุตู ูู ุฑุตูุฏ ุงูุฅุฏูู ุนูุฏ ุงูููุงููุฉ ุนูู deposit
- ุฅุถุงูุฉ ูุฑุตูุฏ ุงูุฅุฏูู ุนูุฏ ุงูููุงููุฉ ุนูู withdrawal
- ุฎุตู ูู ุฑุตูุฏ ุงููุณุชุฎุฏู ุนูุฏ ุงูููุงููุฉ ุนูู withdrawal
- ุชุญุฏูุซ ุชููุงุฆู ูู 30 ุซุงููุฉ
- ุชุณุฌูู ุดุงูู ูุฌููุน ุงูุนูููุงุช ุงููุงููุฉ

โ **ุงููููุงุช ุงููุนุฏูุฉ:**
- `src/components/admin/admin-header.tsx` - ุนุฑุถ ุงูุฑุตูุฏ ุงูุฏููุงูููู
- `src/modules/deposits/deposit.controller.js` - ุฎุตู ูู ุงูุฅุฏูู ุนูุฏ deposit
- `src/modules/withdrawals/withdrawal.controller.js` - ุฅุฏุงุฑุฉ ุงููุจุงูุบ ุนูุฏ withdrawal

---

**ุขุฎุฑ ุชุญุฏูุซ:** ${new Date().toLocaleDateString('ar-EG')}  
**ุงูุญุงูุฉ:** ๐ข Active & Working
