# Docker Compose for Production-like Local Development
# This setup includes all services: App, Redis Cluster, MongoDB Replica Set, NGINX

version: '3.8'

services:
  # ==========================================
  # NGINX Load Balancer
  # ==========================================
  nginx:
    image: nginx:alpine
    container_name: accounts_store_nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docs/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/ssl:ro
    depends_on:
      - app1
      - app2
      - app3
    networks:
      - app_network
    restart: unless-stopped

  # ==========================================
  # Node.js Application Instances (3 replicas)
  # ==========================================
  app1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: accounts_store_app1
    environment:
      - NODE_ENV=production
      - PORT=5000
      - INSTANCE_ID=1
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/accountsstore?replicaSet=rs0
      - REDIS_HOST=redis-cluster
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
    depends_on:
      - mongo1
      - redis-node1
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  app2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: accounts_store_app2
    environment:
      - NODE_ENV=production
      - PORT=5000
      - INSTANCE_ID=2
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/accountsstore?replicaSet=rs0
      - REDIS_HOST=redis-cluster
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
    depends_on:
      - mongo1
      - redis-node1
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  app3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: accounts_store_app3
    environment:
      - NODE_ENV=production
      - PORT=5000
      - INSTANCE_ID=3
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/accountsstore?replicaSet=rs0
      - REDIS_HOST=redis-cluster
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
    depends_on:
      - mongo1
      - redis-node1
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # ==========================================
  # MongoDB Replica Set (3 nodes)
  # ==========================================
  mongo1:
    image: mongo:7
    container_name: accounts_store_mongo1
    command: mongod --replSet rs0 --bind_ip_all
    ports:
      - "27017:27017"
    volumes:
      - mongo1_data:/data/db
      - mongo1_config:/data/configdb
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  mongo2:
    image: mongo:7
    container_name: accounts_store_mongo2
    command: mongod --replSet rs0 --bind_ip_all
    ports:
      - "27018:27017"
    volumes:
      - mongo2_data:/data/db
      - mongo2_config:/data/configdb
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  mongo3:
    image: mongo:7
    container_name: accounts_store_mongo3
    command: mongod --replSet rs0 --bind_ip_all
    ports:
      - "27019:27017"
    volumes:
      - mongo3_data:/data/db
      - mongo3_config:/data/configdb
    networks:
      - app_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # MongoDB Replica Set Initialization
  mongo-init:
    image: mongo:7
    container_name: mongo_init
    depends_on:
      - mongo1
      - mongo2
      - mongo3
    networks:
      - app_network
    restart: "no"
    command: >
      bash -c "
        sleep 10 &&
        mongosh --host mongo1:27017 --eval '
          rs.initiate({
            _id: \"rs0\",
            members: [
              { _id: 0, host: \"mongo1:27017\", priority: 2 },
              { _id: 1, host: \"mongo2:27017\", priority: 1 },
              { _id: 2, host: \"mongo3:27017\", priority: 1 }
            ]
          })
        ' &&
        echo 'MongoDB Replica Set initialized successfully'
      "

  # ==========================================
  # Redis Cluster (6 nodes: 3 masters + 3 replicas)
  # ==========================================
  redis-node1:
    image: redis:7-alpine
    container_name: redis_node1
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis1_data:/data
    networks:
      - app_network
    restart: unless-stopped

  redis-node2:
    image: redis:7-alpine
    container_name: redis_node2
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --requirepass ${REDIS_PASSWORD}
    ports:
      - "6380:6379"
    volumes:
      - redis2_data:/data
    networks:
      - app_network
    restart: unless-stopped

  redis-node3:
    image: redis:7-alpine
    container_name: redis_node3
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --requirepass ${REDIS_PASSWORD}
    ports:
      - "6381:6379"
    volumes:
      - redis3_data:/data
    networks:
      - app_network
    restart: unless-stopped

  redis-node4:
    image: redis:7-alpine
    container_name: redis_node4
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --requirepass ${REDIS_PASSWORD}
    ports:
      - "6382:6379"
    volumes:
      - redis4_data:/data
    networks:
      - app_network
    restart: unless-stopped

  redis-node5:
    image: redis:7-alpine
    container_name: redis_node5
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --requirepass ${REDIS_PASSWORD}
    ports:
      - "6383:6379"
    volumes:
      - redis5_data:/data
    networks:
      - app_network
    restart: unless-stopped

  redis-node6:
    image: redis:7-alpine
    container_name: redis_node6
    command: redis-server --cluster-enabled yes --cluster-config-file nodes.conf --cluster-node-timeout 5000 --appendonly yes --requirepass ${REDIS_PASSWORD}
    ports:
      - "6384:6379"
    volumes:
      - redis6_data:/data
    networks:
      - app_network
    restart: unless-stopped

  # Redis Cluster Initialization
  redis-cluster-init:
    image: redis:7-alpine
    container_name: redis_cluster_init
    depends_on:
      - redis-node1
      - redis-node2
      - redis-node3
      - redis-node4
      - redis-node5
      - redis-node6
    networks:
      - app_network
    restart: "no"
    command: >
      sh -c "
        sleep 5 &&
        redis-cli -a ${REDIS_PASSWORD} --cluster create 
        redis-node1:6379 
        redis-node2:6379 
        redis-node3:6379 
        redis-node4:6379 
        redis-node5:6379 
        redis-node6:6379 
        --cluster-replicas 1 
        --cluster-yes &&
        echo 'Redis Cluster initialized successfully'
      "

  # ==========================================
  # Monitoring Stack
  # ==========================================

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: accounts_store_prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - app_network
    restart: unless-stopped

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: accounts_store_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=redis-datasource
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
    networks:
      - app_network
    restart: unless-stopped

  # Redis Exporter (for Prometheus)
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: redis_exporter
    environment:
      - REDIS_ADDR=redis-node1:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    ports:
      - "9121:9121"
    networks:
      - app_network
    restart: unless-stopped

  # MongoDB Exporter (for Prometheus)
  mongodb-exporter:
    image: percona/mongodb_exporter:latest
    container_name: mongodb_exporter
    environment:
      - MONGODB_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/?replicaSet=rs0
    ports:
      - "9216:9216"
    networks:
      - app_network
    restart: unless-stopped

networks:
  app_network:
    driver: bridge

volumes:
  mongo1_data:
  mongo1_config:
  mongo2_data:
  mongo2_config:
  mongo3_data:
  mongo3_config:
  redis1_data:
  redis2_data:
  redis3_data:
  redis4_data:
  redis5_data:
  redis6_data:
  prometheus_data:
  grafana_data:
